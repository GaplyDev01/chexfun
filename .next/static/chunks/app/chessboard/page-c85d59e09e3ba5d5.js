(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[11],{5982:(e,t,a)=>{"use strict";a.d(t,{N:()=>n});let n=(0,a(907).UU)("https://ospgpgpahqgalaufcomo.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zcGdwZ3BhaHFnYWxhdWZjb21vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1NzYzMzIsImV4cCI6MjA2MTE1MjMzMn0.houQzJX0k4S9MbnPODy13rK8oIXq-QwuuRxD9lOjE9s")},6206:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>f});var n=a(5881),o=a(6797),r=a(1346),i=a(3212),l=a(9268),s=a(5982);function c(e){let{initialSeconds:t,isRunning:a,onTimeout:r,keyProp:i}=e,[l,s]=(0,o.useState)(t),c=(0,o.useRef)(null);(0,o.useEffect)(()=>{s(t)},[t,i]),(0,o.useEffect)(()=>{if(!a){c.current&&clearInterval(c.current);return}return c.current=setInterval(()=>{s(e=>e<=1?(r(),c.current&&clearInterval(c.current),0):e-1)},1e3),()=>{c.current&&clearInterval(c.current)}},[a,r]);let d=Math.floor(l/60),m=l<10;return(0,n.jsxs)("span",{className:"font-mono text-lg",style:{color:m?"var(--danger, red)":void 0,fontWeight:m?"bold":void 0},"aria-live":"polite",children:[d,":",(l%60).toString().padStart(2,"0")]})}function d(e){let t=Math.floor(e/60);return"".concat(t,":").concat((e%60).toString().padStart(2,"0"))}function m(e){let{fen:t,whiteName:a,blackName:o,whiteTime:r,blackTime:i,status:s}=e;return(0,n.jsxs)("div",{className:"bg-black bg-opacity-60 rounded-lg p-4 flex flex-col items-center w-fit",children:[(0,n.jsxs)("div",{className:"flex justify-between w-full mb-2",children:[(0,n.jsxs)("span",{className:"text-white font-bold",children:[a," (",d(r),")"]}),(0,n.jsxs)("span",{className:"text-white font-bold",children:[o," (",d(i),")"]})]}),(0,n.jsx)(l.Ve,{position:t,boardWidth:400,arePiecesDraggable:!1,boardOrientation:"white"}),"active"!==s&&(0,n.jsxs)("div",{className:"mt-2 text-lg text-red-400",children:["Game Over: ",s]})]})}function f(){let[e,t]=(0,o.useState)(!1),[a,d]=(0,o.useState)(!1),[f,u]=(0,o.useState)(null),{address:h,status:g}=(0,r.DK)(),[p,y]=(0,o.useState)(new i.d$),[w,v]=(0,o.useState)(null),[b]=(0,o.useState)(300),[x]=(0,o.useState)(300),[_,j]=(0,o.useState)("w"),[k,S]=(0,o.useState)("active"),[N,I]=(0,o.useState)(null),[E,B]=(0,o.useState)(null),[W,D]=(0,o.useState)(!1),[M,C]=(0,o.useState)(null),[R,z]=(0,o.useState)(!1);async function U(e){if("active"!==k)return;let t=new i.d$(p.fen());console.log("[DEBUG] makeAMove - FEN before move:",p.fen(),"Move:",e);let a=t.move(e);if(console.log("[DEBUG] makeAMove - FEN after move:",t.fen(),"Move result:",a),a&&a.captured&&(C({piece:a.captured,color:"w"===a.color?"b":"w"}),z(!0),setTimeout(()=>z(!1),2e3)),y(t),a&&w){let e=t.history().length;await s.N.from("moves").insert([{game_id:w,move_number:e,move:a.san}]),j(t.turn()),"BOT"===N&&"b"===t.turn()&&"active"===k&&setTimeout(async()=>{let e=new i.d$(t.fen()),a=e.moves();if(a.length){let t=a[Math.floor(Math.random()*a.length)];e.move(t);let n=e.history().length;await s.N.from("moves").insert([{game_id:w,move_number:n,move:t}]),y(e),j(e.turn())}},650)}return a}async function q(){S("timeout"),w&&await s.N.from("games").update({status:"timeout"}).eq("id",w)}return(0,o.useEffect)(()=>{let e=new URLSearchParams(window.location.search).get("gameId");if(v(e),!e)return;async function a(){let{data:a,error:n}=await s.N.from("games").select("black_player,status,white_player,white_player_id,black_player_id,ready_white,ready_black").eq("id",e).single();!n&&a&&(I(a.black_player||null),S(a.status),console.log("[DEBUG] fetchPlayers:",a),h&&a.white_player===h?(t(!!a.ready_white),d(!!a.ready_black)):h&&a.black_player===h&&(t(!!a.ready_black),d(!!a.ready_white)))}(async function(){let{data:t,error:a}=await s.N.from("moves").select("move").eq("game_id",e).order("move_number",{ascending:!0});if(a)return;let n=new i.d$;for(let e of(console.log("[DEBUG] Replaying moves:",t),t||[])){let t=n.fen(),a=n.move(e.move);console.log("[DEBUG] Move: ".concat(e.move,", FEN before: ").concat(t,", FEN after: ").concat(n.fen(),", Move result:"),a)}y(n),console.log("[DEBUG] Final FEN after replay:",n.fen())})(),a();let n=s.N.channel("public:moves").on("postgres_changes",{event:"INSERT",schema:"public",table:"moves",filter:"game_id=eq.".concat(e)},e=>{e.new&&e.new.move&&y(t=>{let a=new i.d$(t.fen());return a.move(e.new.move),j(a.turn()),a})}).subscribe(),o=s.N.channel("public:games").on("postgres_changes",{event:"UPDATE",schema:"public",table:"games",filter:"id=eq.".concat(e)},e=>{e.new&&e.new.status&&S(e.new.status),e.new&&e.new.black_player&&I(e.new.black_player),h&&e.new.white_player===h?(t(!!e.new.ready_white),d(!!e.new.ready_black)):h&&e.new.black_player===h&&(t(!!e.new.ready_black),d(!!e.new.ready_white))}).subscribe();return()=>{s.N.removeChannel(n),s.N.removeChannel(o)}},[h]),(0,o.useEffect)(()=>{"waiting"===k&&N&&a&&e&&!f&&w&&(async()=>{let e=.5>Math.random()?"w":"b",{data:t}=await s.N.from("games").select("white_player,black_player,white_player_id,black_player_id").eq("id",w).single();if(!t)return;console.log("[DEBUG] assignColors - gameData:",t,"address:",h,"myColor:",e),h===t.white_player&&"w"===e&&console.warn("[DEBUG] Attempting to set both players to white:",{address:h,gameData:t});let a={white_player:"w"===e?h:t.black_player,black_player:"b"===e?h:t.white_player,white_player_id:"w"===e?t.white_player_id:t.black_player_id,black_player_id:"b"===e?t.white_player_id:t.black_player_id,status:"ready",assigned:!0};console.log("[DEBUG] assignColors - update:",a),await s.N.from("games").update(a).eq("id",w),u(e)})()},[k,N,a,e,f,h,w]),(0,o.useEffect)(()=>{if("ready"===k&&f){B(5);let e=setInterval(()=>{B(t=>null===t?null:t<=1?(clearInterval(e),S("active"),null):t-1)},1e3);return()=>clearInterval(e)}},[k,f]),"1"===new URLSearchParams(window.location.search).get("overlay")?(0,n.jsx)("div",{className:"flex flex-col items-center justify-center min-h-screen bg-transparent",children:(0,n.jsx)(m,{fen:p.fen(),whiteName:"White",blackName:"Black",whiteTime:b,blackTime:x,status:k})}):(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",minHeight:"100vh",justifyContent:"center"},children:[(0,n.jsxs)("div",{className:"card",style:{padding:"2.5em 2em",background:"var(--card-bg)",border:"1px solid var(--accent)",boxShadow:"0 0 24px #4f8cff33",width:560,maxWidth:"98vw"},children:[M&&R&&(0,n.jsx)("div",{style:{position:"absolute",top:24,left:0,right:0,margin:"0 auto",width:80,height:80,display:"flex",alignItems:"center",justifyContent:"center",zIndex:10,fontSize:64,opacity:+!!R,transition:"opacity 0.5s",pointerEvents:"none",color:"w"===M.color?"#fff":"#222",textShadow:"0 2px 8px #000"},children:{p:"w"===M.color?"♙":"♟",n:"w"===M.color?"♘":"♞",b:"w"===M.color?"♗":"♝",r:"w"===M.color?"♖":"♜",q:"w"===M.color?"♕":"♛",k:"w"===M.color?"♔":"♚"}[M.piece]||"?"}),w&&(0,n.jsxs)("div",{style:{marginBottom:"1em",color:"var(--accent-2)",fontFamily:"var(--font-mono)",fontSize:"1.1em"},children:["Game ID: ",w]}),"waiting"===k&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{style:{marginBottom:"1em",color:"var(--accent)",fontWeight:600,textAlign:"center"},children:["Waiting for an opponent to join...",(0,n.jsx)("br",{}),"Share this link: ",(0,n.jsx)("span",{style:{fontFamily:"var(--font-mono)"},children:window.location.href})]}),(0,n.jsx)("button",{style:{marginBottom:24,width:"100%",background:"#ff4d4f",color:"#fff",fontWeight:700,padding:"0.75em",borderRadius:8,border:"none",fontSize:"1.1em",cursor:W?"not-allowed":"pointer",opacity:W?.7:1},disabled:W,onClick:async()=>{w&&(D(!0),await s.N.from("games").delete().eq("id",w),window.location.href="/lobby")},children:"Leave Lobby"}),(0,n.jsxs)("div",{style:{marginTop:24,textAlign:"center"},children:[(0,n.jsx)("button",{style:{background:e?"#4caf50":"#1976d2",color:"#fff",fontWeight:700,padding:"0.75em",borderRadius:8,border:"none",fontSize:"1.1em",cursor:e?"not-allowed":"pointer",opacity:e?.7:1,marginRight:16},disabled:e,onClick:async()=>{if(!w)return;let e=h===N?"ready_black":"ready_white";await s.N.from("games").update({[e]:!0}).eq("id",w),t(!0)},children:e?"Ready!":"I am Ready"}),(0,n.jsx)("span",{style:{marginLeft:8,color:a?"#4caf50":"#aaa",fontWeight:600},children:a?"Opponent Ready":"Waiting for Opponent"})]})]}),"ready"===k&&(0,n.jsx)("div",{style:{marginBottom:"1em",color:"var(--accent)",fontWeight:600,textAlign:"center"},children:"Both players are ready! Assigning colors and starting soon..."}),E&&E>0&&(0,n.jsxs)("div",{style:{marginBottom:"1em",color:"var(--accent)",fontWeight:600,textAlign:"center"},children:["Opponent joined! Game starting in ",E," second",1!==E?"s":"","..."]}),"connected"===g&&h&&(0,n.jsxs)("div",{style:{color:"var(--accent-2)",fontFamily:"var(--font-mono)",fontSize:"1.1em",marginBottom:"1em"},children:["Your Address: ",h.slice(0,6),"...",h.slice(-4)]})]}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:24,gap:32},children:[(0,n.jsxs)("div",{style:{textAlign:"center"},children:[(0,n.jsx)("span",{style:{fontWeight:700,color:"var(--accent)"},children:"White"}),(0,n.jsx)(c,{initialSeconds:b,isRunning:"w"===_&&"active"===k,onTimeout:q,keyProp:"white-".concat(w)})]}),(0,n.jsxs)("div",{style:{textAlign:"center"},children:[(0,n.jsx)("span",{style:{fontWeight:700,color:"var(--accent)"},children:"Black"}),(0,n.jsx)(c,{initialSeconds:x,isRunning:"b"===_&&"active"===k,onTimeout:q,keyProp:"black-".concat(w)})]})]}),(0,n.jsx)("div",{style:{marginBottom:24},children:(0,n.jsx)(l.Ve,{position:p.fen(),onPieceDrop:function(e,t){return"active"===k&&!E&&!!new i.d$(p.fen()).move({from:e,to:t,promotion:"q"})&&(U({from:e,to:t,promotion:"q"}),!0)},boardWidth:480,arePiecesDraggable:"active"===k&&!E&&!!N,customBoardStyle:{borderRadius:12,boxShadow:"0 0 24px #4f8cff33"}})}),(0,n.jsx)("button",{style:{marginBottom:24,width:"100%",background:"var(--accent)",color:"#fff",fontWeight:700,padding:"0.75em",borderRadius:8,border:"none",fontSize:"1.1em",cursor:"active"===k?"pointer":"not-allowed",opacity:"active"===k?1:.5},disabled:"active"!==k,onClick:async()=>{"active"===k&&w&&(await s.N.from("games").update({status:"forfeited"}).eq("id",w),S("forfeited"))},children:"Forfeit"}),(0,n.jsx)("div",{style:{color:"var(--foreground)",fontWeight:600,textAlign:"center"},children:"active"===k?("w"===_?"White":"Black")+" to move":"Game status: ".concat(k)})]})}},9337:(e,t,a)=>{Promise.resolve().then(a.bind(a,6206))}},e=>{var t=t=>e(e.s=t);e.O(0,[946,346,907,212,364,770,358],()=>t(9337)),_N_E=e.O()}]);